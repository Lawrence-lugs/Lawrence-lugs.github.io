---
title: "Analog Circuit Design using BAG2 vs. BAG3"
layout: post
date: '2022-08-24 10:00:00 +0200'
categories:
- learningnotes
---

Notes from the MOSAIC bootcamp talk by Zhaokai Liu. 

## Introduction to BAG

* BAG allows us to reuse the design process.
* Allows to iterate through the design process very quickly using the generator.
  * Since everything is parametrized, you can generate and get feedback very quickly.

## BAG2 generator

Time-interleaved SAR ADC. Uses hand-drawn primitives, uses LAYGO and other XBase-generated instances.
Manually assembled with the memory and scan chan block.
Taped out in intel22FFL.

XBase Layout Engine
* AnalogBase
  * Matching
  * Wire Adjustment for current rules
* DigitalBase
  * Compact layout
* TemplateBase
  * Custom base??

|![](\images\2022-08-24-16-11-23.png)|![](\images\2022-08-24-16-11-31.png)|
|:-:|:-:|
|AnalogBase|DigitalBase|

Hydra Spine ASIC - 8 channels of analog front-ends. Intel22FFL. ADC uses BAG2 LAYGO, DAC uses BAG2 XBase.

TrackManager exists in both BAG2 and BAG3. This categorizes wires and puts specific widths for specific types of wires in one place, instead of all over the code.

## BAG3 generators

BAG3 is capable of simulation and design.

BAG3 no longer has separate bases. Only MOSBase.

![](\images\2022-08-24-16-17-31.png)

In MOSBase0 you have three different instances. If they share the same tiling information. Similar to LAYGObase, but in laygobase you have to make sure that all rows are flipped but here you have more flexiblity. Can also be any combination of any tap and substrate rows. There are also no boundaries.

![](\images\2022-08-24-16-19-31.png)

The MOSBase wrapper generates dummies and makes the layout DRC-clean.

MOSBase floorpan is defined in a yaml file, defines the channel length, top layer, wire specs.

One MOSBase can have multiple tiles, and it defines the arrangement of said tiles (abut_list) **what's the second number mean in abut list? how do you start going sideways?**.
Multiple rows in each tile (like a base in analogbase)

![](\images\2022-08-24-16-21-15.png)

You can now control conn_layer+1 layer wires. G_MATCH and DS_MATCH wire types exist now as well, and can be specified differently.

![](\images\2022-08-24-16-22-32.png)

Can break wires to satisfy quantized metal length.

![](\images\2022-08-24-16-26-30.png)
![](\images\2022-08-24-16-26-38.png)

The code seems to be much less than BAG2, likely because a lot of the work is done in the YAML files now.

The wrapper fills in gaps and finishes the layouts after MOSBase creates taps and transistors.

Wrapper creates clean boundaries, dummies and diffusion regions.

![](\images\2022-08-24-16-30-32.png)

![](\images\2022-08-24-16-31-26.png)

Can make half-templates for symmetric designs.

![](\images\2022-08-24-16-32-41.png)

## Simulation & Design in BAG3

BAG2 sets up testbench with schematic templates and anlaysis in ADE XL. BAG generates the testbench and uses generated DUT to simulate, which takes a long time.

BAG3 uses a generic schematic template (complete with sources, etc). TestBenchManager generates the testbench from a yaml file, and the loads and stimulus as well.

**Do you still need to define the schematic templates for a new generator, and then the rest of the testbench is attached to the schematic and the symbol from something autogenerated in a YAML file?**

Creates a netlist from the testbenchmanager, and then runs spectre on the generated netlist.

NEVER OPENS VIRTUOSO, making it much faster.

* MeasurementManager
  * Takes a generated DUT and handles measurement for specific performance metrics.

* DesignerBase
  * Can sweep DUT parameters, design scripting.
  * Basically runs MeasurementManager and testBenchManager with different DUTs

![](\images\2022-08-24-16-38-01.png)

DesignerBase returns a sweep of different design options.

## Workspace structure and setup

1 workspace per process and project.

![](\images\2022-08-24-16-41-27.png)

## R and C

Still done in similar way as BAG2. Setup user primitives, templatebase to set them up in the array. See below.

## Example full generator architecture

![](\images\2022-08-24-17-07-44.png)

It took about 1.5 months to write the code for the SAR ADC, with a decent range of input parameters.

*How well would a colleague continue with the code when you hand it over? Do you think BAG3 is structured enough and reusable?*

I would say it depends on user experience. 

*Did [the use of generators] initially, kind of slow you down?*

It was worth it because verifying your own design, trying to assemble blocks together takes a much longer time using the generators. 

For example, though, with circuits like the SAR ADC it's worth the time, because of reusability, but i'd rather assemble the things in a manual way after that.